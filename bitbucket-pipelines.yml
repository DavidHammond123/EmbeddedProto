image: atlassian/default-image:2
pipelines:
  default:
    - step:    
        caches:
          - git-modules
        script:            
          - apt-get update; apt-get install -y jq unzip lib32ncurses5 lib32z1 lib32stdc++6 tree
#          - export BITBUCKET_ACCESS_TOKEN=$(curl -s -X POST -u "$OAUTH_CLIENT_KEY:$OAUTH_CLIENT_SECRET" https://bitbucket.org/site/oauth2/access_token -d grant_type=client_credentials | jq ".access_token")
#          - export BITBUCKET_PULL_REQUEST_ID=$(curl -s -XGET "https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_OWNER/$BITBUCKET_REPO_SLUG/pullrequests?pagelen=5&state=OPEN&access_token=$BITBUCKET_ACCESS_TOKEN" | jq ".values[] | select(.source.branch.name==\"$BITBUCKET_BRANCH\") | .id"
          - git submodule update --recursive --init
          - source bitbucket-pipelines-dependencies.sh
          - ./build-wrapper-linux-x86/build-wrapper-linux-x86-32 --out-dir SonarQube-output make clean all
          - export SONAR_SCANNER_OPTS="-Xmx1024m"
          - ./sonar-scanner-cli-3.3.0.1492-linux/bin/sonar-scanner -Dproject.settings=sonar-project.properties -Dsonar.login=492dba2b1a7da82eaea36308ce177f6033626bca -Dsonar.cfamily.build-wrapper-output=SonarQube-output
          - ./build_test
                 
definitions:
  caches:
    git-modules: .git/modules

